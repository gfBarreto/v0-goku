#####################################################################
# Macros
####################################################################

[gcode_macro Lubrifica_Z]
description: "Lubrifica o eixo Z subindo e descendo 5 vezes após homing"
gcode:
    M117 Lubrificando eixo Z...
    G90                             ; Usa coordenadas absolutas
    G28 Z                           ; Faz homing do eixo Z

    {% set z_max = printer.toolhead.axis_maximum.z|float %}

    {% for i in range(5) %}
      {% set msg = '"Ciclo %d de 5"' % (i + 1) %}
      M117 {msg}
      G1 Z5 F3000                   ; Sobe até Z=5 mm
      G1 Z{z_max} F3000             ; Desce até o limite
    {% endfor %}

    M117 Lubrificação concluída!
    
[gcode_macro TESTE_ACELERACAO_V0]
description: "Teste de aceleração XY sem LEDs, adaptado para a Voron 0.2"
gcode:
    G90
    M117 Iniciando Teste de Aceleração
    G28
    G1 Z10 F3000

    {% set velocidades = [100, 150, 200, 250] %}
    {% set pos_ext = [(10, 10), (110, 10), (110, 110), (10, 110)] %}
    {% set pos_int = [(0, 0), (40, 0), (40, 40), (0, 40)] %}
    {% set offsets = [
        (10, 10),
        (70, 10),
        (70, 70),
        (10, 70)
    ] %}
    {% set rep = params.REPETICOES|default(1)|int %}

    {% for vel in velocidades %}
      {% set msg = '"Testando a %d mm/s"' % vel %}
      RESPOND PREFIX="ACEL_V0" MSG={msg}
      M117 {msg}

      {% if vel >= 200 %}
        SET_VELOCITY_LIMIT VELOCITY={vel} ACCEL=5000 SQUARE_CORNER_VELOCITY=5
      {% else %}
        SET_VELOCITY_LIMIT VELOCITY={vel} ACCEL=3000 SQUARE_CORNER_VELOCITY=5
      {% endif %}

      {% for i in range(rep) %}
        ; Quadrado externo
        G1 X{pos_ext[0][0]} Y{pos_ext[0][1]} F{vel * 60}
        G1 X{pos_ext[1][0]} Y{pos_ext[1][1]} F{vel * 60}
        G1 X{pos_ext[2][0]} Y{pos_ext[2][1]} F{vel * 60}
        G1 X{pos_ext[3][0]} Y{pos_ext[3][1]} F{vel * 60}
        G1 X{pos_ext[0][0]} Y{pos_ext[0][1]} F{vel * 60}

        ; Quadrados internos em cada canto
        {% for offset in offsets %}
          {% set ox = offset[0] %}
          {% set oy = offset[1] %}
          G1 X{ox + pos_int[0][0]} Y{oy + pos_int[0][1]} F{vel * 60}
          G1 X{ox + pos_int[1][0]} Y{oy + pos_int[1][1]} F{vel * 60}
          G1 X{ox + pos_int[2][0]} Y{oy + pos_int[2][1]} F{vel * 60}
          G1 X{ox + pos_int[3][0]} Y{oy + pos_int[3][1]} F{vel * 60}
          G1 X{ox + pos_int[0][0]} Y{oy + pos_int[0][1]} F{vel * 60}
          G1 X{ox + 40} Y{oy + 40} F{vel * 60}
          G1 X{ox + 0}  Y{oy + 40} F{vel * 60}
          G1 X{ox + 40} Y{oy + 0}  F{vel * 60}
          G1 X{ox + 0}  Y{oy + 0}  F{vel * 60}
        {% endfor %}
      {% endfor %}

      G4 P2000
    {% endfor %}

    M117 Teste Finalizado

[gcode_macro PID_BICO]
description: "Calibra o PID do bico com temperatura configurável"
gcode:
  {% set temp = params.TEMP|default(230)|int %}
  {% if temp < 100 or temp > 280 %}
    RESPOND PREFIX="PID_BICO" MSG="TEMP inválido (100–300°C)"
    M117 TEMP inválido!
    CANCEL
  {% endif %}

  {% set msg = '"PID Bico iniciando a %d°C..."' % temp %}
  RESPOND PREFIX="PID_BICO" MSG={msg}
  M117 PID BICO...
  PID_CALIBRATE HEATER=extruder TARGET={temp}

[gcode_macro PID_MESA]
description: "Calibra o PID da mesa com temperatura configurável"
gcode:
  {% set temp = params.TEMP|default(70)|int %}
  {% if temp < 40 or temp > 130 %}
    RESPOND PREFIX="PID_MESA" MSG="TEMP inválido (40–130°C)"
    M117 TEMP inválido!
    CANCEL
  {% endif %}

  {% set msg = '"PID Mesa iniciando a %d°C..."' % temp %}
  RESPOND PREFIX="PID_MESA" MSG={msg}
  M117 PID MESA...
  PID_CALIBRATE HEATER=heater_bed TARGET={temp}

[gcode_macro NEVERMORE_ON]
gcode:
    SET_PIN PIN=nevermore_fan VALUE=1.0
    SET_GCODE_VARIABLE MACRO=NEVERMORE_CONTROL VARIABLE=state VALUE=True
    RESPOND MSG="Nevermore ligado"

[gcode_macro NEVERMORE_OFF]
gcode:
    SET_PIN PIN=nevermore_fan VALUE=0.0
    SET_GCODE_VARIABLE MACRO=NEVERMORE_CONTROL VARIABLE=state VALUE=False
    RESPOND MSG="Nevermore desligado"

[delayed_gcode _NEVERMORE_MONITOR]
initial_duration: 5
gcode:
    {% set temp = printer["temperature_sensor camara_temp"].temperature %}
    {% set fan_state = printer["output_pin nevermore_fan"].value|float %}
    {% set state = printer["gcode_macro NEVERMORE_CONTROL"].state %}

    {% if temp > 32 and fan_state < 0.9 %}
        SET_PIN PIN=nevermore_fan VALUE=1.0
        SET_GCODE_VARIABLE MACRO=NEVERMORE_CONTROL VARIABLE=state VALUE=True
        {% set msg = '"Ligando o Nevermore (temp=%.1f°C)"' % temp %}
        RESPOND PREFIX="Nevermore" MSG={msg}

    {% elif temp < 29 and fan_state >= 0.5 %}
        SET_PIN PIN=nevermore_fan VALUE=0.0
        SET_GCODE_VARIABLE MACRO=NEVERMORE_CONTROL VARIABLE=state VALUE=False
        {% set msg = '"Desligando o Nevermore (temp=%.1f°C)"' % temp %}
        RESPOND PREFIX="Nevermore" MSG={msg}
    {% endif %}

    UPDATE_DELAYED_GCODE ID=_NEVERMORE_MONITOR DURATION=10

[gcode_macro NEVERMORE_CONTROL]
variable_state: False
gcode:
    {% if state %}
        RESPOND MSG="Nevermore está: LIGADO"
    {% else %}
        RESPOND MSG="Nevermore está: DESLIGADO"
    {% endif %}
    
[gcode_macro PAUSE]
description: Pause da Voron 0.2 com descida de mesa de 20mm
rename_existing: PAUSE_BASE
gcode:
  LED_LARANJA
  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
  {% set idle_timeout = client.idle_timeout|default(0) %}
  {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}
  {% set restore = False if printer.toolhead.extruder == '' else True if params.RESTORE|default(1)|int == 1 else False %}
  {% set pos = printer.toolhead.position %}
  {% set resume_pos = '"%.3f,%.3f,%.3f"' % (pos[0], pos[1], pos[2]) %}

  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=resume_position VALUE={resume_pos}
  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=last_extruder_temp VALUE="{{'restore': restore, 'temp': temp}}"

  {% if idle_timeout > 0 %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=restore_idle_timeout VALUE={printer.configfile.settings.idle_timeout.timeout}
    SET_IDLE_TIMEOUT TIMEOUT={idle_timeout}
  {% endif %}

  PAUSE_BASE
  {client.user_pause_macro|default("")}

  G91
  G1 Z20 F3000               ; sobe 20mm (abaixa a mesa)
  G90
  G1 X115 Y5 F6000           ; vai para frente da impressora

[gcode_macro RESUME]
description: Resume da Voron 0.2 com retorno à altura correta
rename_existing: RESUME_BASE
variable_last_extruder_temp: {'restore': False, 'temp': 0}
variable_restore_idle_timeout: 0
variable_idle_state: False
variable_resume_position: ('0.0', '0.0', '0.0')
gcode:
  LED_BRANCO
  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
  {% set velocity = printer.configfile.settings.pause_resume.recover_velocity %}
  {% set sp_move = client.speed_move|default(velocity) %}
  {% set runout_resume = True if client.runout_sensor|default("") == ""     
                    else True if not printer[client.runout_sensor].enabled  
                    else printer[client.runout_sensor].filament_detected %}
  {% set can_extrude = True if printer.toolhead.extruder == ''           
                  else printer[printer.toolhead.extruder].can_extrude %}
  {% set do_resume = False %}
  {% set prompt_txt = [] %}

  {% if printer.idle_timeout.state|upper == "IDLE" or idle_state %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=False
    {% if last_extruder_temp.restore %}
      {% set msg = "Restaurando %s para %.1f°C" % (printer.toolhead.extruder, last_extruder_temp.temp) %}
      RESPOND TYPE=echo MSG="{msg}"
      M109 S{last_extruder_temp.temp}
      {% set do_resume = True %}
    {% elif can_extrude %}
      {% set do_resume = True %}
    {% else %}
      {% set error_msg = "Resume abortado: %s não está quente." % printer.toolhead.extruder %}
      RESPOND TYPE=error MSG="{error_msg}"
      {% set _d = prompt_txt.append(error_msg) %}
    {% endif %}
  {% elif can_extrude %}
    {% set do_resume = True %}
  {% else %}
    {% set error_msg = "Resume abortado: %s não está quente." % printer.toolhead.extruder %}
    RESPOND TYPE=error MSG="{error_msg}"
    {% set _d = prompt_txt.append(error_msg) %}
  {% endif %}

  {% if runout_resume %}
    {% if do_resume %}
      {% if restore_idle_timeout > 0 %}
        SET_IDLE_TIMEOUT TIMEOUT={restore_idle_timeout}
      {% endif %}
      {client.user_resume_macro|default("")}
      RESUME_BASE VELOCITY={params.VELOCITY|default(sp_move)}

      {% set x = resume_position[0]|float %}
      {% set y = resume_position[1]|float %}
      {% set z = resume_position[2]|float %}
      G90
      G1 X{x} Y{y} Z{z} F6000
    {% endif %}
  {% else %}
    {% set sensor_name = (client.runout_sensor.split(" "))[1] if " " in client.runout_sensor else client.runout_sensor %}
    {% set msg = "Resume abortado: %s sem filamento." % sensor_name %}
    RESPOND TYPE=error MSG="{msg}"
    {% set _d = prompt_txt.append(msg) %}
  {% endif %}

  {% if not (runout_resume and do_resume) %}
    RESPOND TYPE=command MSG="action:prompt_begin RESUME abortado !!!"
    {% for element in prompt_txt %}
      {% set prompt_line = "action:prompt_text %s" % element %}
      RESPOND TYPE=command MSG="{prompt_line}"
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
    RESPOND TYPE=command MSG="action:prompt_show"
  {% endif %}

[gcode_macro CANCEL_PRINT]
description: "Cancela a impressão com segurança"
rename_existing: BASE_CANCEL_PRINT
gcode:
    M117 Cancelando impressão...
    M104 S0
    M140 S0
    M107
    G91
    G1 Z10 F300
    G90
    G1 X0 Y120 F6000
    M84
    RESPOND TYPE=command MSG="action:cancelled"

[gcode_macro TROCA_FILAMENTO]
description: Troca de filamento para Voron 0.2
gcode:
  LED_LARANJA
  RESPOND TYPE=command MSG="filament_change"
  M117 Trocando filamento...

  M400
  G91
  G1 E-5 F300
  G1 E-130 F1000
  G90

  PAUSE

[gcode_macro LAYER_NOTIFICATION]
description: "Exibe a camada atual no visor"
gcode:
    {% if printer.print_stats.info.current_layer is defined and printer.print_stats.info.total_layer is defined %}
        M117 Camada: {printer.print_stats.info.current_layer}/{printer.print_stats.info.total_layer}
    {% else %}
        M117 Camada: {printer.print_stats.info.current_layer}
    {% endif %}
    
[gcode_macro PRINT_START]
gcode:
  {% set file = printer["print_stats"].filename|default("")|upper %}
  {% if "ABS" in file or "TRITAN" in file %}
  NEVERMORE_ON
  {% endif %}
  
  M117 Iniciando Impressão
  RESPOND TYPE=command MSG="print_started"
  Liga_BarraLed
  #LOGO_LARANJA
  #Liga_led

  # Coleta os parâmetros do fatiador ou define padrões
  {% set target_bed = params.BED|default(60)|int %}
  {% set target_extruder = params.EXTRUDER|default(200)|int %}
  {% set target_chamber = params.CHAMBER|default(40)|int %}
  {% set x_center = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_center = printer.toolhead.axis_maximum.y|float / 2 %}

    G4 P1000  ; Aguarda 1s para limpar registradores do StallGuard

  # Homing apenas se necessário
  {% if not 'x' in printer.toolhead.homed_axes or not 'y' in printer.toolhead.homed_axes %}
   # LOGO_AZUL
    G28 X Y
  {% endif %}
  {% if not 'z' in printer.toolhead.homed_axes %}
   # LOGO_AZUL
    G28 Z
  {% endif %}

  G90
  G1 X{x_center} Y{y_center} Z15 F5000

  # Controle da temperatura da mesa
  #LOGO_LARANJA
  {% if target_bed > 65 %}
    #M106 S255
    M190 S{target_bed}
  {% else %}
    M190 S{target_bed}
    # G4 P300000  ; 5 min de estabilização opcional
  {% endif %}

  # Aquecimento do hotend (confirma extrusor antes)
  {% if printer.toolhead.extruder != '' %}
    SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"
    M109 S{target_extruder}
  {% else %}
    M117 Nenhum extrusor ativo detectado!
  {% endif %}

  # Linha de purga
  Line_purge

  #LOGO_VERDE
  M117 Imprimindo...

[gcode_macro user_pause_macro]
description: "Macro chamada pela extensão PAUSE"
gcode:
    M117 Pausando...
    SAVE_GCODE_STATE NAME=PAUSE_STATE
    G91
    G1 Z20 F3000
    G90
    G1 X115 Y5 F6000
    M117 Impressão pausada

[gcode_macro LOAD_FILAMENT]
gcode:
   M109 T0 S210                   ; set extruder temp and wait 
   M83                            ; set extruder to relative
   G1 E30 F300                    ; load
   G1 E15 F150                    ; prime nozzle with filament
   M82                            ; set extruder to absolute
    
[gcode_macro UNLOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E10 F300                    ; extrude a little to soften tip
   G1 E-40 F1800                  ; retract some, but not too much or it will jam
   M82                            ; set extruder to absolute

[gcode_macro M205]
description: Alternative to "jerk speed"
gcode:
    {% if 'X' in params %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X|int}
    {% elif 'Y' in params %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y|int}
    {% endif %}

#--------------------------------------------------------------------

[gcode_macro M566]
gcode:

#--------------------------------------------------------------------

[gcode_macro T0]
gcode:
  

#--------------------------------------------------------------------

[gcode_macro PRINT_END]
description: "Finaliza a impressão na Voron 0.2"
gcode:
    RESPOND TYPE=command MSG="print_done"

    M400
    G91
    G1 E-5 F1800                   ; Retração
    G90                            ; Coordenadas absolutas

    G1 X60 Y60 F6000               ; Move para o centro

    {% set zmax = printer.toolhead.axis_maximum.z|float %}
    G1 Z{zmax} F300                ; Sobe o eixo Z até o máximo (desce a mesa)

    M104 S0                        ; Desliga hotend
    M140 S0                        ; Desliga cama
    M107                           ; Desliga fan
    M84                            ; Desliga motores

    Desliga_BarraLed
    Liga_BarraLed
    Desliga_BarraLed
    Liga_BarraLed
    Desliga_BarraLed
    Liga_BarraLed
    Desliga_BarraLed
    NEVERMORE_OFF
    M117 Terminou!



#--------------------------------------------------------------------

[gcode_macro CUSTOM_PROBE_CALIBRATE]
gcode:
    QUERY_ENDSTOPS

    # Pega o probe
    SS_CONDITIONAL_TAKE_PROBE

    G90
    G1 Y60 F6000
    G1 X40 F6000

    # Executa a calibração do probe
    PROBE_CALIBRATE


[gcode_macro CALIBRATE_Z_ENDSTOP]
gcode:
    # Home nos eixos X, Y e Z
    LOGO_AZUL
    G28
    #SS_STOW_PROBE

    # Move para o centro da mesa e posiciona a uma altura segura
    G90
    G1 Y60 F6000
    G1 X60 F6000
    G1 Z10 F1500

    # Instrução para o usuário
    M117 Calibrando endstop do Z
    Z_ENDSTOP_CALIBRATE
    Logo_off
    #CUSTOM_PROBE_CALIBRATE


[gcode_macro CALIBRATE_BED_SCREWS_ADJUST]
gcode:
    
    # Muda a cor do logo para azul
    LOGO_AZUL
    
    # Exibe mensagem de aquecimento
    M117 Aquecendo hotend e cama...

    # Define as temperaturas do hotend e da cama
    M104 S170     ; Define a temperatura do hotend para 195°C
    M140 S60      ; Define a temperatura da cama para 70°C

    # Aguarda até que ambos alcancem as temperaturas
    M109 S195     ; Aguarda o hotend atingir 195°C
    M190 S70      ; Aguarda a cama atingir 70°C

    # Exibe mensagem e começa o processo de homing
    M117 Iniciando calibração...

    

    # Home nos eixos X, Y e Z
    G28

    # Ajuste dos parafusos da mesa
    BED_SCREWS_ADJUST

    # Desliga o logo
    Logo-off



[gcode_macro G29]
gcode:
    G91
    G1 Z1
    G90
    #Query_Probe
    #SS_CONDITIONAL_TAKE_PROBE
    #BED_MESH_CALIBRATE
    #SS_STOW_PROBE

#--------------------------------------------------------------------

[gcode_macro _HOME_X]
gcode:
    Logo_azul
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.85 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    G28 X
    G91
    G1 X-2 F1200
    G4 P1000
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    Logo_off

[gcode_macro _HOME_Y]
gcode:
    Logo_azul
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.85 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    G28 Y
    G91
    G1 Y-2 F1200
    G4 P1000
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    Logo_off

[homing_override]
axes: xyz
gcode:
    Logo_azul
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

    {% if home_all or 'X' in params %}
        _HOME_X
    {% endif %}
    
    {% if home_all or 'Y' in params %}
        _HOME_Y
    {% endif %}
    
    {% if home_all or 'Z' in params %}
        G28 Z
    {% endif %}

    # Move to center of the bed after all homing
    {% if home_all %}
        G90
        G1 X60 Y60 F6000
    {% endif %}

    Logo_off

